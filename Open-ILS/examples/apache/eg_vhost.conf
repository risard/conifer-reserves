# ----------------------------------------------------------------------------------
# This is the global Evergreen virtual host config.  Anything you want published
# through all virtual hosts (port 80, port 443, etc.) should live in here.
# ----------------------------------------------------------------------------------


# ----------------------------------------------------------------------------------
# Point / to the opac
# ----------------------------------------------------------------------------------
RedirectMatch 301 ^/$ /opac/en-US/skin/default/xml/index.xml

# ----------------------------------------------------------------------------------
# Assign a default locale to the accessible OPAC
# ----------------------------------------------------------------------------------
RedirectMatch 301 ^/opac/extras/slimpac/start.html$ /opac/en-US/extras/slimpac/start.html
RedirectMatch 301 ^/opac/extras/slimpac/advanced.html$ /opac/en-US/extras/slimpac/advanced.html



# ----------------------------------------------------------------------------------
# Configure the gateway
# ----------------------------------------------------------------------------------
OSRFGatewayConfig /openils/conf/opensrf_core.xml


# ----------------------------------------------------------------------------------
# Set up the book jackets URL
# XXX This pulls images from Amazon, don't use this in a production environment
# ----------------------------------------------------------------------------------
RewriteEngine on
ProxyTimeout 2
RewriteRule /opac/extras/jacket/small/(.*) \
    http://images.amazon.com/images/P/$1.01._SCMZZZZZZZ_.jpg [P,L]
RewriteRule /opac/extras/jacket/large/(.*) \
    http://images.amazon.com/images/P/$1.01._SCLZZZZZZZ_.jpg [P,L]



# ----------------------------------------------------------------------------------
# Added content plugin
# ----------------------------------------------------------------------------------
<Location /opac/extras/ac/>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::AddedContent
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location>

	
# ----------------------------------------------------------------------------------
# Configure the OPAC
# ----------------------------------------------------------------------------------
<LocationMatch /opac/>
    AddType application/xhtml+xml .xml
   
    # - configure mod_xmlent
    XMLEntStripPI "yes"
    XMLEntEscapeScript "no"
    XMLEntStripComments "yes"
    XMLEntContentType "text/html; charset=utf-8"
    # forces quirks mode which we want for now
    XMLEntStripDoctype "yes" 

    # - set up the include handlers
    Options +Includes
    AddOutputFilter INCLUDES .xsl
    AddOutputFilter INCLUDES;XMLENT .xml
		    
    # add languages as necessary
    SetEnvIf Request_URI "/en-US/" locale=en-US
    SetEnvIf Request_URI "/fr-CA/" locale=fr-CA
    SetEnvIf Request_URI ".*" OILS_OPAC_BASE=/opac/
    
    # This gives you the option to configure a different host to serve OPAC images from
    # Specify the hostname (withouth protocol) and path to the images.  Protocol will
    # be determined at runtime
    #SetEnvIf Request_URI ".*" OILS_OPAC_IMAGES_HOST=static.example.org/opac/
    #SetEnvIf Request_URI ".*" OILS_OPAC_CSS_HOST=static.example.org/opac/
    #SetEnvIf Request_URI ".*" OILS_OPAC_JS_HOST=static.example.org/opac/

</LocationMatch>


# ----------------------------------------------------------------------------------
# Force SSL on the OPAC's "My Account" page
# ----------------------------------------------------------------------------------
<LocationMatch .*/myopac.xml>
    SSLRequireSSL
</LocationMatch>

<LocationMatch /opac/extras/>
    AddType application/xhtml+xml .xml
</LocationMatch>

<LocationMatch /opac/.*/extras/slimpac/>
    AddOutputFilter INCLUDES;XMLENT .html
</LocationMatch>
	
# ----------------------------------------------------------------------------------
# Run server-side XUL through xmlent to load the correct XML entities
# ----------------------------------------------------------------------------------
<LocationMatch /xul/.*\.xul$>
    Options +Includes
    XMLEntContentType "application/vnd.mozilla.xul+xml"
    AddOutputFilter INCLUDES;XMLENT .xul
    allow from all

    # We only support one locale (en-US) for the time being
    SetEnv locale=en-US
</LocationMatch>

# ----------------------------------------------------------------------------------
# Supercat feeds
# ----------------------------------------------------------------------------------
<Location /opac/extras/oisbn>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::SuperCat::oisbn
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location>
<Location /opac/extras/supercat>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::SuperCat::supercat
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location>
<Location /opac/extras/unapi>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::SuperCat::unapi
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location>
<Location /opac/extras/feed/bookbag>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::SuperCat::bookbag_feed
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location>
<Location /opac/extras/opensearch>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::SuperCat::opensearch_feed
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location>
<Location /opac/extras/feed/freshmeat>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::SuperCat::changes_feed
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location>
<Location /opac/extras/browse>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::SuperCat::string_browse
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location> 	
	
# ----------------------------------------------------------------------------------
# Module for processing staff-client offline scripts lives here
# ----------------------------------------------------------------------------------
<Directory "/openils/var/cgi-bin/offline">
    AddHandler cgi-script .pl
    AllowOverride None
    Options +ExecCGI
    allow from all
</Directory>
	
	
# ----------------------------------------------------------------------------------
# OpenSRF JSON gateway
# ----------------------------------------------------------------------------------
<Location /gateway>
    SetHandler osrf_json_gateway_module
    allow from all
</Location>

	
# ----------------------------------------------------------------------------------
# The exporter lives here
# ----------------------------------------------------------------------------------
<Location /exporter>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::Exporter
    Options +ExecCGI
    allow from all
</Location>

# ----------------------------------------------------------------------------------
# Reporting output lives here
# ----------------------------------------------------------------------------------
<Location /reporter/>
    SetHandler perl-script
    PerlSetVar ProxyTitle "Report Login"
    PerlSetVar ProxyDescription "Please log in to view this report"
    PerlSetVar ProxyPermissions "VIEW_REPORT_OUTPUT"
    PerlHandler OpenILS::WWW::Proxy
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location>

# ----------------------------------------------------------------------------------
# Reports GUI
# ----------------------------------------------------------------------------------
<LocationMatch /reports/>
    Options +Includes
    AddOutputFilter INCLUDES .xhtml
</LocationMatch>

# ----------------------------------------------------------------------------------
# XML-RPC gateway
# ----------------------------------------------------------------------------------
<Location /xml-rpc>
    SetHandler perl-script
    PerlHandler OpenILS::WWW::XMLRPCGateway
    Options +ExecCGI
    PerlSendHeader On
    allow from all
</Location>


# ----------------------------------------------------------------------------------
# Django admin interface (experimental)
#  - requires mod_python and django
#  - requires a symlink from WEBROOT/media to 
#  /usr/lib/python2.4/site-packages/django/contrib/admin/media/ (or similar)
# ----------------------------------------------------------------------------------
#<Location /ils_setup/>
#   Order deny,allow
#   Deny from all
#   Allow from 10.0.0.0/8
#   SetHandler mod_python
#   PythonHandler django.core.handlers.modpython
#   SetEnv DJANGO_SETTINGS_MODULE ils_admin.settings
#   PythonDebug On
#   PythonPath "['/openils/var/admin/', '/usr/lib/python2.4/site-packages/'] +sys.path"
#   PythonAutoReload On
#</Location>


